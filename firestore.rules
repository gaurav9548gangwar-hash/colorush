/**
 * @fileoverview Firestore Security Rules for Tiranga Wingo.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data,
 * while allowing public read access to game round data. Admin roles are managed
 * using an "Existence over Content" strategy in the /roles_admin collection.
 *
 * Data Structure:
 * - /users/{userId}: User profile information, accessible only by the user.
 * - /game_rounds/{gameId}: Game round data, publicly readable, admin-writeable.
 * - /users/{userId}/bets/{betId}: Bets placed by a user, accessible only by that user.
 * - /users/{userId}/deposits/{depositId}: Deposit requests, accessible only by the user who created it.
 * - /users/{userId}/withdrawals/{withdrawalId}: Withdrawal requests, accessible only by the user who created it.
 * - /roles_admin/{userId}: Admin role definitions. If a document exists for a user, they are an admin.
 *
 * Key Security Decisions:
 * - User data is strictly private, accessible only to the owning user.
 * - Game round data is public for reads, but admin-protected for writes.
 * - Listing operations are generally restricted to the owner of the data or admin users.
 * - Phone Authentication needs to be enabled in the Firebase Console to resolve the "auth/operation-not-allowed" error.
 *
 * Denormalization for Authorization:
 * This ruleset leverages path-based ownership to avoid unnecessary `get()` calls.
 * For example, bets, deposits, and withdrawals are stored under the user's ID,
 * allowing rules to directly check `request.auth.uid == userId` without additional reads.
 *
 * Structural Segregation:
 * Drafts and published content are not applicable in this data model. All data
 * is either private (user-specific) or public (game rounds).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profile data.
     * @path /users/{userId}
     * @allow (get, list, update, delete) User with matching userId can access their own data.
     * @allow (create) User can create their own document if the userId matches their auth UID.
     * @deny (get, list, create, update, delete) Any other user cannot access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
       function isAdmin() {
          return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }

      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // Allow admins to list users.

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if (isExistingOwner(userId) || isAdmin()) && request.resource.data.id == resource.data.id; // Enforce immutability of userId.
      allow delete: if isExistingOwner(userId) || isAdmin();
    }

    /**
     * @description Grants public read access to game round data and restricts write access to admins.
     * @path /game_rounds/{gameId}
     * @allow (get, list) Anyone can read game round data.
     * @allow (create, update, delete) Only admins can modify game round data.
     * @deny (create, update, delete) Non-admins cannot modify game round data.
     * @principle Allows public reads and restricts writes to admins.
     */
    match /game_rounds/{gameId} {
        function isSignedIn() {
          return request.auth != null;
        }
        function isAdmin() {
          return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Grants access to bets placed by a specific user.
     * @path /users/{userId}/bets/{betId}
     * @allow (get, list, create, update, delete) User with matching userId can access their own bets.
     * @deny (get, list, create, update, delete) Any other user cannot access this data.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/bets/{betId} {
        function isSignedIn() {
          return request.auth != null;
        }
        function isOwner(userId) {
          return isSignedIn() && request.auth.uid == userId;
        }
        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId; // Enforce immutability of userId.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to deposit requests made by a specific user.
     * @path /users/{userId}/deposits/{depositId}
     * @allow (get, list, create, update, delete) User with matching userId can access their own deposit requests, and admins can manage them.
     * @deny (get, list, create, update, delete) Any other user cannot access this data.
     * @principle Enforces document ownership for user creation and allows admin management.
     */
    match /users/{userId}/deposits/{depositId} {
        function isSignedIn() {
          return request.auth != null;
        }
        function isOwner(userId) {
          return isSignedIn() && request.auth.uid == userId;
        }
        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }
        function isAdmin() {
          return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && (isOwner(userId) || isAdmin()) && request.resource.data.userId == resource.data.userId; // Enforce immutability of userId.
      allow delete: if isExistingOwner(userId) && isAdmin();
    }

    /**
     * @description Grants access to withdrawal requests made by a specific user.
     * @path /users/{userId}/withdrawals/{withdrawalId}
     * @allow (get, list, create, update, delete) User with matching userId can access their own withdrawal requests, and admins can manage them.
     * @deny (get, list, create, update, delete) Any other user cannot access this data.
     * @principle Enforces document ownership for user creation and allows admin management.
     */
    match /users/{userId}/withdrawals/{withdrawalId} {
        function isSignedIn() {
          return request.auth != null;
        }
        function isOwner(userId) {
          return isSignedIn() && request.auth.uid == userId;
        }
        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }
        function isAdmin() {
          return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }

      allow get: if isOwner(userId) || isAdmin();
      allow list: if isOwner(userId) || isAdmin();

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && (isOwner(userId) || isAdmin()) && request.resource.data.userId == resource.data.userId; // Enforce immutability of userId.
      allow delete: if isExistingOwner(userId) && isAdmin();
    }

    /**
     * @description Defines admin roles using "Existence over Content".
     * @path /roles_admin/{userId}
     * @allow (get, list) Admins can get and list admin roles.
     * @allow (create) Any user can create their admin record (self-nomination), but only an existing admin can actually grant the role.
     * @allow (update, delete) Only admins can modify the admin role.
     * @deny (get, list, create, update, delete) Non-admins cannot access this data.
     * @principle Uses the existence of a document to define admin status.
     */
    match /roles_admin/{userId} {
        function isSignedIn() {
          return request.auth != null;
        }
        function isAdmin() {
          return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }
        function isOwner(userId) {
          return isSignedIn() && request.auth.uid == userId;
        }
        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }

      allow get: if isAdmin();
      allow list: if isAdmin();

      allow create: if isAdmin();
      allow update: if isAdmin() && isExistingOwner(userId);
      allow delete: if isAdmin() && isExistingOwner(userId);
    }
  }
}
